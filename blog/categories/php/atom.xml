<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: PHP | Freelance Projects]]></title>
  <link href="http://uw-freelancer.github.io/blog/categories/php/atom.xml" rel="self"/>
  <link href="http://uw-freelancer.github.io/"/>
  <updated>2013-07-07T21:58:49+05:30</updated>
  <id>http://uw-freelancer.github.io/</id>
  <author>
    <name><![CDATA[Upeksha Wisidagama]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Mundane Experiments with Apache Prefork MPM and Mod_PHP]]></title>
    <link href="http://uw-freelancer.github.io/blog/mundane-experiments-with-apache-mpm_prefork-and-mod_php/"/>
    <updated>2012-04-12T06:15:00+05:30</updated>
    <id>http://uw-freelancer.github.io/blog/mundane-experiments-with-apache-mpm_prefork-and-mod_php</id>
    <content type="html"><![CDATA[<p>This is an experiment of this earthly world rather than a heavenly or spiritual one. Apache is a popular web server eventhough it can&rsquo;t solve the <a href="http://en.wikipedia.org/wiki/C10k_problem" >C10k Problem</a>.</p>

<p>Prefork (Module Identifier:mpm_prefork_module) is the default Multi Processing Module for Apache Server in Ubuntu.</p>

<p><blockquote><p>This Multi-Processing Module (MPM) implements a non-threaded, pre-forking web server. Each server process may answer incoming requests, and a parent process manages the size of the server pool.</p></blockquote></p>

<p>The other MPMs are Event and Worker (there are others of course: mpm_netware, mpm_os2, mpm_winnt). Visit <a href="http://httpd.apache.org/docs/current/mod/" >Apache Module Index</a> to find out more.</p>

<p><img class='center' src="/images/server/apache-prefork-mpm-in-action-top.png" title="Apache Prefork MPM in Action in Top" alt="Apache Prefork MPM in Action in Top" /></p>

<p>I&rsquo;ve written a <a href="/blog/setup-local-ubuntu-server/" >How to install a local Ubuntu Server</a> post explaining how I set up a testing server. Now, I am going to use that server for the following experiments.</p>

<p>PHP is loaded as Module by default. Log into your fresh server (described in the above linked article), and run the <code>top</code> command.</p>

<p>Next enable highlighting by pressing <code>z</code>. Then enable column highlighting by pressing <code>x</code>. You can change the sorting of the rows by columns. Just press <code>&lt;</code> and <code>&gt;</code> until you get the required column highlighted. The above figure shows the rows as ordered by &lsquo;Resident Memory (RE)&rsquo; they consume. The most Resident Memory consuming process is the <code>mysqld</code>. This is the MySQL deamon, accounting for 33Mbs out of total 1GB RAM.</p>

<p><blockquote><p>PID: 1668 is the Apache2 parent process owned by root. It consumes 7Mbs of RAM. Each of the children of Apache2 parent process consumes ~ 4.4Mb RAM. But 1MB of RAM is being shared.</p></blockquote></p>

<p>How the server decided to spawn 9 children? Let&rsquo;s see the apache2 configuration files stored in &lsquo;/etc/apache2/&rsquo;.</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>&lsquo;Apache Prefork MPM Configuration (/etc/apache2/apache2.conf)&rsquo; </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;h1&gt;prefork MPM&lt;/h1&gt;
</span><span class='line'>
</span><span class='line'>&lt;h1&gt;StartServers: number of server processes to start&lt;/h1&gt;
</span><span class='line'>
</span><span class='line'>&lt;h1&gt;MinSpareServers: minimum number of server processes which are kept spare&lt;/h1&gt;
</span><span class='line'>
</span><span class='line'>&lt;h1&gt;MaxSpareServers: maximum number of server processes which are kept spare&lt;/h1&gt;
</span><span class='line'>
</span><span class='line'>&lt;h1&gt;MaxClients: maximum number of server processes allowed to start&lt;/h1&gt;
</span><span class='line'>
</span><span class='line'>&lt;h1&gt;MaxRequestsPerChild: maximum number of requests a server process serves&lt;/h1&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;&lt;IfModule mpm_prefork_module&gt;&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;pre&gt;&lt;code&gt;StartServers          5
</span><span class='line'>MinSpareServers       5
</span><span class='line'>MaxSpareServers      10
</span><span class='line'>MaxClients          150
</span><span class='line'>MaxRequestsPerChild   0
</span><span class='line'>&lt;/code&gt;&lt;/pre&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;&lt;/IfModule&gt;
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>By default, apache2 starts only 5 child processes(StartServers). I simulated a high traffic scenario using Apache Benchmarking tool (ab). As a resulf of the high traffic, Apache2 increased the number of processes to 9. Next, I restarted the server using <code>sudo service apache2 restart</code>. Then the number of child processes shown was 5. You can change the parameters under <code>mpm_prefork_module</code> to match your client needs and wants.</p>

<p>Next I changed &lsquo;Start&rsquo;, &lsquo;Min&rsquo; and &lsquo;Max&rsquo; servers to 1. I even chaged &lsquo;MaxClients&rsquo; to 1. I need to run only one apache2 child. See the <code>top</code> output for one apache2 child process (PID: 4227).</p>

<p><img class='center' src="/images/server/prefork-with-only-one-server.png" title="Prefork with only one server" alt="Prefork with only one server" /></p>

<h2>Benchmarking Apache Performance with Varing number of Child Processes</h2>


<p>Let&rsquo;s benchmark the performance of Apache with One Child and Five Children with <code>mod_php</code> enabled. We serve a simple html file.</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>&lsquo;index.html&rsquo; </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="nt">&lt;html&gt;&lt;body&gt;&lt;h1&gt;</span>It works!<span class="nt">&lt;/h1&gt;&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;p&gt;</span>This is the default web page for this server.<span class="nt">&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;p&gt;</span>The web server software is running but no content has been added, yet.<span class="nt">&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;p&gt;&lt;/body&gt;&lt;/html&gt;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>First, change the Prefork configuration to run only one child as described above.</p>

<p>Run <code>ab -n 1000 -c 10 -g one-child.dat http://192.168.1.8/</code></p>

<p>Then change Apache Prefork to span five children.</p>

<p>Run <code>ab -n 1000 -c 10 -g five-children.dat http://192.168.1.8/</code></p>

<p>Then plot the graph. We&rsquo;ll be using Gnuplot for plotting. Create the Prefork.p</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>&lsquo;Prefork.p&rsquo; </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;h1&gt;output as png image&lt;/h1&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;set terminal png&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;h1&gt;save file to &amp;ldquo;prefork-benchmarking.png&amp;rdquo;&lt;/h1&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;set output &amp;ldquo;prefork-benchmarking.png&amp;rdquo;&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;h1&gt;graph title&lt;/h1&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;set title &amp;ldquo;Apache2 Benchmarking with Prefork MPM&amp;rdquo;&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;h1&gt;nicer aspect ratio <span class="k">for </span>image size&lt;/h1&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;set size 1,0.7&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;h1&gt;y-axis grid&lt;/h1&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;set grid y&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;h1&gt;x-axis label&lt;/h1&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;set xlabel &amp;ldquo;request&amp;rdquo;&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;h1&gt;y-axis label&lt;/h1&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;set ylabel &amp;ldquo;response <span class="nb">time</span> <span class="o">(</span>ms<span class="o">)</span>&amp;rdquo;&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;h1&gt;plot data from data files&lt;/h1&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;plot &amp;ldquo;one-child.dat&amp;rdquo; using 9 smooth sbezier with lines title &amp;ldquo;One Child&amp;rdquo;, <span class="se">\</span>
</span><span class='line'>&amp;ldquo;five-children.dat&amp;rdquo; using 9 smooth sbezier with lines title &amp;ldquo;Five Children&amp;rdquo;
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>Now plot the data using <code>gnuplot Prefork.p</code>.</p>

<p><img class='center' src="/images/server/apache2-prefork-benchmarking-with-low-concurrency.png" title="Apache2 Prefork Benchmarking with Low Concurrency" alt="Apache2 Prefork Benchmarking with Low Concurrency" /></p>

<p>The following is the plot when the concurrecy level is set to 100 (use -c 100 instead -c 10 in ab tool).</p>

<p><img class='center' src="/images/server/apache2-prefork-benchmarking-with-high-concurrency.png" title="Apache2 Prefork Benchmarking with High Concurrency" alt="Apache2 Prefork Benchmarking with High Concurrency" /></p>

<p>Now you have the basic building blocks of Apache2 benchmarking. You can tweak various parameters, collect data and plot. Observe the plot. Contemplate or even meditate on the data and the visualization of the data. Gnuplot can plot more than two datasets. Infact, it is capable of plotting in 3D. It is also used as a plotting engine by third-party applications like Octave.</p>

<p><blockquote><p>Gnuplot was originally created to allow scientists and students to visualize mathematical functions and data interactively, but has grown to support many non-interactive uses such as web scripting.</p></blockquote></p>

<h2>Relaxation of 'one-per-second' Rule - Apache2 Process Creation</h2>


<p>As of Apache 1.3, the code will relax the one-per-second rule. It will spawn one, wait a second, then spawn two, wait a second, then spawn four, and it will continue exponentially until it is spawning 32 children per second. It will stop whenever it satisfies the MinSpareServers setting. Read more about <a href="http://httpd.apache.org/docs/current/misc/perf-tuning.html" >Apache2 Performance Tuning</a>.</p>

<p>Happy Apache2 Prefork Benchmarking with or without <code>mod_php</code>!</p>
]]></content>
  </entry>
  
</feed>
